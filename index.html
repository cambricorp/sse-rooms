<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Rocket Rooms Demo</title>

<style>
h1, h2, h3, h4, h5, h6 {
  font-family: Arial, sans-serif;
}

.rooms {
  display: flex;
}

.room {
  flex: auto;
}

.join-room-label {
  margin-top: 50px;
  margin-bottom: 5px;
}
</style>
</head>

<body>

  <p>
    Your Name: <input type="text" id="input-user" name="from">
  </p>
  <p>
    Messages can be posted over HTTP:
    <code>curl -d 'from=name&amp;text=message' localhost:8000/room/left</code>
  </p>
  <p>
    Rooms can also be watched from the command line:
    <code>curl localhost:8000/room/right</code>
  </p>

  <div class="rooms">
    <div class="room" id="room1">
      <h2>#left</h2>
      <form class="new-message">
        <input type="text" name="room" placeholder="Room" value="room1">
        <input type="text" name="message" placeholder="Message" value="Rocket is awesome!">
        <button type="submit">Send</button>
      </form>
      <div class="messages"></div>
    </div>
  </div>

  <div>
    <div class="join-room-label">Join a room</div>
    <input type="text" name="room" placeholder="Room" value="room1">
    <button class="join-room-button" type="submit">Join Room</button>
  </div>

<script>
function subscribe(uri, dest) {
  const events = new EventSource(uri);
  events.onmessage = function(event) {
    const p = document.createElement("p");
    p.innerText = event.data;
    dest.appendChild(p);
  }
}

function listen() {
  const events = new EventSource("sse");

  events.addEventListener("chat_message", function(event) {
    const newElement = document.createElement("li");
    newElement.innerHTML = "message: " + event.data;

    console.log("message: " + event.data);

    /*
    const eventList = document.querySelector(".list");
    eventList.appendChild(newElement);
    */
  });
}

listen();

let randomUserID = Math.floor(Math.random() * 100) + 1; // this will be sent automatically with a cookie in practice

subscribe("/room/left/" + randomUserID, document.getElementById("room1"));

document.querySelector(".join-room-button").addEventListener("click", function(e) {
  e.preventDefault();

  alert('asdf');
});

function listen_submit(form, uri) {
  form.addEventListener("submit", function(e) {
    e.preventDefault();

    const message = form.elements["message"].value;
    if (!message) {
      return;
    }

    const from = document.getElementById("input-user").value || "guest";

    const body = "from=" + encodeURIComponent(from) + "&text=" + encodeURIComponent(message);

    fetch(uri, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body
    }).then(() => {
      form.elements["message"].value = "";
    });
  });
}

listen_submit(document.querySelector("#room1 .new-message"), "/room/left");
</script>
</body>
</html>
